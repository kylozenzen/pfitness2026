<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Planet Strength V2</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#7e22ce" />
  <link rel="manifest" href="#" id="manifest-placeholder" />
  <script>tailwind = { disableWarning: true }</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; }

    /* BASE LIGHT MODE - Better visual fidelity */
    body { 
      font-family: 'Inter', sans-serif; 
      background: #f8f8f8;
      color: #1a1a1a;
      -webkit-tap-highlight-color: transparent; 
      overscroll-behavior: none; 
      margin: 0;
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    /* Enhanced shadows and borders for light mode */
    .shadow-sm { box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.08); }
    .shadow { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08); }
    .shadow-lg { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06); }
    .shadow-xl { box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.08); }
    .shadow-2xl { box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15), 0 8px 12px rgba(0, 0, 0, 0.1); }

    /* Better card borders in light mode */
    .border-gray-100 { border-color: #e0e0e0 !important; }
    .border-gray-200 { border-color: #d0d0d0 !important; }
    .bg-white { background: #ffffff !important; border: 1px solid #e5e5e5; }
    .bg-gray-50 { background: #fafafa !important; }
    .bg-gray-100 { background: #f0f0f0 !important; }

    /* DARK MODE - Subtle neon underglow */
    body.dark-mode { 
      background: #0a0a0a;
      color: #e5e5e5;
    }
    body.dark-mode .bg-white { 
      background: #1a1a1a !important; 
      color: #e5e5e5 !important;
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.15),
                  0 0 40px rgba(139, 92, 246, 0.08);
      border: 1px solid rgba(139, 92, 246, 0.2);
    }
    body.dark-mode .bg-gray-50 { background: #0a0a0a !important; }
    body.dark-mode .bg-gray-100 { 
      background: #1a1a1a !important;
      box-shadow: 0 0 15px rgba(139, 92, 246, 0.1);
    }
    body.dark-mode .bg-gray-200 { background: #2a2a2a !important; }
    body.dark-mode .text-gray-900 { color: #f5f5f5 !important; }
    body.dark-mode .text-gray-800 { color: #e5e5e5 !important; }
    body.dark-mode .text-gray-700 { color: #d0d0d0 !important; }
    body.dark-mode .text-gray-600 { color: #a0a0a0 !important; }
    body.dark-mode .text-gray-500 { color: #808080 !important; }
    body.dark-mode .text-gray-400 { color: #666666 !important; }
    body.dark-mode .text-gray-300 { color: #808080 !important; }
    body.dark-mode .border-gray-100 { border-color: rgba(139, 92, 246, 0.15) !important; }
    body.dark-mode .border-gray-200 { border-color: rgba(139, 92, 246, 0.2) !important; }
    body.dark-mode .border-gray-300 { border-color: #4a4a4a !important; }

    /* Purple accent with subtle glow */
    body.dark-mode .bg-purple-600 { 
      background: #8b5cf6 !important;
      box-shadow: 0 0 30px rgba(139, 92, 246, 0.4),
                  0 0 60px rgba(139, 92, 246, 0.2);
    }
    body.dark-mode .text-purple-600 { color: #a78bfa !important; }
    body.dark-mode .bg-purple-50 { 
      background: #1a1425 !important;
      border: 1px solid rgba(139, 92, 246, 0.25);
      box-shadow: 0 0 15px rgba(139, 92, 246, 0.1);
    }
    body.dark-mode .text-purple-700 { color: #a78bfa !important; }
    body.dark-mode .border-purple-200 { border-color: rgba(139, 92, 246, 0.3) !important; }
    body.dark-mode .border-purple-400 { border-color: #8b5cf6 !important; }

    /* Dark mode for motivational quotes */
    body.dark-mode .dark-mode-quote-text { color: #ffffff !important; }
    body.dark-mode .dark-mode-quote-author { color: #a78bfa !important; }

    /* Dark mode for cues and progression boxes */
    body.dark-mode .bg-green-50 { 
      background: #0f2f1f !important; 
      border-color: rgba(34, 197, 94, 0.3) !important;
    }
    body.dark-mode .bg-blue-50 { 
      background: #0f1f2f !important; 
      border-color: rgba(59, 130, 246, 0.3) !important;
    }
    body.dark-mode .text-green-700 { color: #4ade80 !important; }
    body.dark-mode .text-blue-700 { color: #60a5fa !important; }
    body.dark-mode .text-green-600 { color: #22c55e !important; }
    body.dark-mode .text-blue-600 { color: #3b82f6 !important; }
    body.dark-mode .border-green-200 { border-color: rgba(34, 197, 94, 0.25) !important; }
    body.dark-mode .border-blue-200 { border-color: rgba(59, 130, 246, 0.25) !important; }

    /* Dark mode for orange warning card */
    body.dark-mode .bg-orange-50 { 
      background: #2f1f0f !important; 
      border-color: rgba(251, 146, 60, 0.3) !important;
    }
    body.dark-mode .bg-red-50 { 
      background: #2f0f0f !important; 
    }
    body.dark-mode .text-orange-900 { color: #fb923c !important; }
    body.dark-mode .text-orange-700 { color: #fdba74 !important; }
    body.dark-mode .border-orange-300 { border-color: rgba(251, 146, 60, 0.4) !important; }
    body.dark-mode .border-orange-200 { border-color: rgba(251, 146, 60, 0.25) !important; }
    body.dark-mode .border-orange-400 { border-color: #fb923c !important; }

    /* Dark mode for yellow completion card */
    body.dark-mode .bg-yellow-50 { 
      background: #2f2f0f !important; 
      border-color: rgba(234, 179, 8, 0.3) !important;
    }
    body.dark-mode .text-yellow-900 { color: #fbbf24 !important; }
    body.dark-mode .border-yellow-300 { border-color: rgba(234, 179, 8, 0.4) !important; }
    body.dark-mode .bg-orange-600 { 
      background: #ea580c !important;
      box-shadow: 0 0 20px rgba(234, 88, 12, 0.3);
    }

    /* Button glow in dark mode */
    body.dark-mode button.bg-purple-600 {
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4),
                  0 0 40px rgba(139, 92, 246, 0.2);
    }

    /* Better shadows and borders for light mode */
    .shadow-sm { box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06); }
    .shadow { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06); }
    .shadow-lg { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08); }
    .shadow-xl { box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15), 0 4px 8px rgba(0, 0, 0, 0.1); }
    .shadow-2xl { box-shadow: 0 12px 24px rgba(0, 0, 0, 0.18), 0 6px 12px rgba(0, 0, 0, 0.12); }

    /* Stronger borders in light mode */
    .border { border-width: 1px; }
    .border-2 { border-width: 2px; }
    .border-gray-100 { border-color: #e5e7eb; }
    .border-gray-200 { border-color: #d1d5db; }
    .border-gray-300 { border-color: #9ca3af; }

    /* Subtle glow shadows in dark mode */
    body.dark-mode .shadow-sm { box-shadow: 0 0 10px rgba(139, 92, 246, 0.08); }
    body.dark-mode .shadow { box-shadow: 0 0 15px rgba(139, 92, 246, 0.1); }
    body.dark-mode .shadow-lg { box-shadow: 0 0 20px rgba(139, 92, 246, 0.15); }
    body.dark-mode .shadow-xl { box-shadow: 0 0 25px rgba(139, 92, 246, 0.2); }
    body.dark-mode .shadow-2xl { box-shadow: 0 0 30px rgba(139, 92, 246, 0.25); }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes expandHeight { from { max-height: 0; opacity: 0; } to { max-height: 2000px; opacity: 1; } }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideInLeft { from { opacity: 0; transform: translateX(-100%); } to { opacity: 1; transform: translateX(0); } }

    .animate-slide-down { animation: slideDown 0.2s ease-out; }
    .animate-slide-up { animation: slideUp 0.2s ease-out; }
    .animate-slide-in-right { animation: slideInRight 0.3s ease-out; }
    .animate-slide-in-left { animation: slideInLeft 0.3s ease-out; }
    .animate-expand { animation: expandHeight 0.3s ease-out; overflow: hidden; }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }

    /* Simplified install prompt */
    .install-prompt {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: #7c3aed;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 1000;
      animation: slideUp 0.2s ease-out;
      max-width: 90%;
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <div id="install-prompt"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ========== PWA SETUP ==========
    const MANIFEST = {
      "name": "Planet Strength",
      "short_name": "PlanetStr",
      "description": "Track your strength progress",
      "start_url": "./",
      "display": "standalone",
      "background_color": "#7e22ce",
      "theme_color": "#7e22ce",
      "orientation": "portrait",
      "icons": [{
        "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%237e22ce' width='100' height='100' rx='20'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white'%3Eüí™%3C/text%3E%3C/svg%3E",
        "sizes": "512x512",
        "type": "image/svg+xml",
        "purpose": "any maskable"
      }]
    };
    const manifestBlob = new Blob([JSON.stringify(MANIFEST)], { type: 'application/json' });
    const manifestURL = URL.createObjectURL(manifestBlob);
    document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

    // Register service worker
    if ('serviceWorker' in navigator) {
      const SW_CODE = `
        const CACHE = 'ps-v2';
        self.addEventListener('install', e => {
          e.waitUntil(caches.open(CACHE).then(cache => cache.addAll(['./', 'https://cdn.tailwindcss.com'])));
        });
        self.addEventListener('fetch', e => {
          e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
        });
      `;
      const swBlob = new Blob([SW_CODE], { type: 'application/javascript' });
      const swURL = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swURL).catch(() => {});
    }

    // PWA Install Prompt Component
    const InstallPrompt = () => {
      const [show, setShow] = useState(false);
      const [prompt, setPrompt] = useState(null);

      useEffect(() => {
        const handler = (e) => {
          e.preventDefault();
          setPrompt(e);
          setShow(true);
        };
        window.addEventListener('beforeinstallprompt', handler);
        return () => window.removeEventListener('beforeinstallprompt', handler);
      }, []);

      const install = async () => {
        if (!prompt) return;
        prompt.prompt();
        await prompt.userChoice;
        setShow(false);
      };

      if (!show) return null;

      return ReactDOM.createPortal(
        <div className="install-prompt">
          <div className="flex items-center gap-3">
            <div className="text-2xl">üì±</div>
            <div className="flex-1">
              <div className="font-bold text-sm">Install App</div>
              <div className="text-xs opacity-80">Add to home screen</div>
            </div>
            <button onClick={install} className="bg-white/20 px-4 py-2 rounded-lg font-bold text-sm">
              Install
            </button>
            <button onClick={() => setShow(false)} className="text-white/60 text-xl px-2">√ó</button>
          </div>
        </div>,
        document.getElementById('install-prompt')
      );
    };


    // ========== ICONS ==========
    const Icon = ({ name, className }) => {
      const icons = {
        Dumbbell: <path d="m6.5 6.5 11 11m4.5 3.5-1-1m-17-17 1 1m14 19 4-4m-20-16 4-4m-3 8 7-7m11 11 7-7" />,
        TrendingUp: <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />,
        User: <g><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></g>,
        Home: <path d="M3 9.5 12 3l9 6.5V21a2 2 0 0 1-2 2h-4v-7H9v7H5a2 2 0 0 1-2-2V9.5Z" />,
        X: <path d="M18 6 6 18M6 6l12 12" />,
        ChevronLeft: <path d="m15 18-6-6 6-6" />,
        ChevronRight: <path d="m9 18 6-6-6-6" />,
        ChevronDown: <path d="m6 9 6 6 6-6" />,
        Clock: <g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>,
        Check: <polyline points="20 6 9 17 4 12" />,
        Trash: <g><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /></g>,
        Activity: <path d="M22 12h-4l-3 9L9 3l-3 9H2" />,
        Sparkles: <g><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3L12 3Z" /></g>,
        Target: <g><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></g>,
        Info: <g><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></g>,
        Trophy: <g><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" /><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" /><path d="M4 22h16" /><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" /><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" /><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" /></g>,
        Lightbulb: <g><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></g>,
        Flame: <path d="M8.5 14.5c0 2 1.5 3.5 3.5 3.5s3.5-1.5 3.5-3.5c0-1.5-1-2.6-2-3.6-.8-.8-1.2-1.5-1.5-2.9-.6 1.1-1.4 1.8-2.2 2.5-1 .9-1.3 2-1.3 4Z" />,
        BookOpen: <g><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></g>,
        BarChart: <g><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></g>,
        Settings: <g><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></g>,
        Moon: <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />,
        List: <g><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></g>
      };
      return (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
          viewBox="0 0 24 24" fill="none" stroke="currentColor"
          strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
          className={className}>
          {icons[name]}
        </svg>
      );
    };

    // ========== STORAGE FIX FOR IOS ==========
    const memoryStorage = {};
    const storage = {
      get: (key, fallback) => { 
        try { 
          const v = localStorage.getItem(key); 
          return v ? JSON.parse(v) : (memoryStorage[key] || fallback); 
        } catch { 
          return memoryStorage[key] || fallback; 
        } 
      },
      set: (key, val) => { 
        try { 
          localStorage.setItem(key, JSON.stringify(val)); 
          memoryStorage[key] = val;
        } catch {
          memoryStorage[key] = val;
        } 
      }
    };

    // ========== CONSTANTS ==========
    const AVATARS = ["ü¶Å","ü¶ç","ü¶ñ","üí™","üèÉ","üßò","ü§ñ","üëΩ","ü¶ä","‚ö°"];

    const GYM_TYPES = {
      planet: { 
        label: "Planet Fitness",
        emoji: "üü£",
        machines: true,
        dumbbells: { available: true, max: 75, increments: [5] },
        barbells: { available: true, standardBar: 45 },
        machineStackCap: 260
      },
      commercial: {
        label: "Commercial Gym",
        emoji: "üèãÔ∏è",
        desc: "LA Fitness, Golds, 24 Hour, etc",
        machines: true,
        dumbbells: { available: true, max: 120, increments: [2.5, 5] },
        barbells: { available: true, standardBar: 45 },
        machineStackCap: 300
      },
      iron: {
        label: "Powerlifting Gym",
        emoji: "‚ö°",
        desc: "Serious iron, heavy weights",
        machines: false,
        dumbbells: { available: true, max: 150, increments: [2.5, 5, 10] },
        barbells: { available: true, standardBar: 45 },
        machineStackCap: null
      },
      home: {
        label: "Home Gym",
        emoji: "üè†",
        machines: false,
        dumbbells: { available: true, max: 100, increments: [5] },
        barbells: { available: true, standardBar: 45 },
        machineStackCap: null
      }
    };

    const EXPERIENCE_LEVELS = [
      { label: 'Beginner', desc: '0‚Äì3 months', detail: 'New to lifting or restarting' },
      { label: 'Novice', desc: '3‚Äì9 months', detail: 'Learning form + consistency' },
      { label: 'Intermediate', desc: '1‚Äì2 years', detail: 'Progressing steadily' },
      { label: 'Advanced', desc: '3+ years', detail: 'Dialed in + consistent' }
    ];

    const ACTIVITY_LEVELS = [
      { label: 'Sedentary', emoji: 'ü™ë', desc: 'Desk job, minimal movement', multiplier: 0.85 },
      { label: 'Lightly Active', emoji: 'üö∂', desc: 'Some walking', multiplier: 0.95 },
      { label: 'Moderately Active', emoji: 'üèÉ', desc: 'Regular movement', multiplier: 1.0 },
      { label: 'Very Active', emoji: 'üí™', desc: 'Physical + training', multiplier: 1.1 },
      { label: 'Athlete', emoji: 'üèÜ', desc: 'High volume training', multiplier: 1.2 }
    ];

    const GOALS = [
      { id: 'strength', label: 'Strength Gain', emoji: 'üí™', desc: 'Push weight up, focus on PRs', bias: { reps: 'lower', cardio: 'lower' } },
      { id: 'recomp', label: 'Body Recomp', emoji: 'üîÑ', desc: 'Build strength while leaning out', bias: { reps: 'middle', cardio: 'middle' } },
      { id: 'fatloss', label: 'Fat Loss', emoji: 'üî•', desc: 'Consistency + reps + recovery', bias: { reps: 'higher', cardio: 'higher' } },
      { id: 'health', label: 'General Health', emoji: '‚ù§Ô∏è', desc: 'Keep it simple and sustainable', bias: { reps: 'middle', cardio: 'middle' } },
    ];

    const DIFFICULTY_LEVELS = [
      { value: 'easy', label: 'Easy', emoji: '‚úÖ', desc: 'Could do 3+ more reps' },
      { value: 'good', label: 'Good', emoji: 'üí™', desc: '1‚Äì2 reps in tank' },
      { value: 'hard', label: 'Hard', emoji: 'üò§', desc: 'Barely finished' },
      { value: 'failed', label: 'Failed', emoji: '‚ùå', desc: "Could not complete" }
    ];

    const motivationalQuotes = [
      { quote: "Stay hard!", author: "David Goggins" },
      { quote: "Good.", author: "Jocko Willink" },
      { quote: "Discipline equals freedom.", author: "Jocko Willink" },
      { quote: "You don't have to be great to start, but you have to start to be great.", author: "Zig Ziglar" },
      { quote: "The only bad workout is the one that didn't happen.", author: "Unknown" },
      { quote: "Success isn't always about greatness. It's about consistency.", author: "Dwayne Johnson" },
      { quote: "The pain you feel today will be the strength you feel tomorrow.", author: "Unknown" },
      { quote: "Don't wish for it, work for it.", author: "Unknown" },
      { quote: "Your body can stand almost anything. It's your mind you have to convince.", author: "Unknown" },
      { quote: "The difference between try and triumph is a little umph.", author: "Unknown" }
    ];

    const EQUIPMENT_DB = {
      // ========== MACHINES ==========
      "chest_press": { 
        type: 'machine',
        name: "Chest Press", 
        target: "Chest", 
        muscles: "Chest, Triceps, Front Delts", 
        tags: ["Push","Upper","Full Body"], 
        stackCap: 260, 
        multipliers: { Male: [0.3,0.55,0.85,1.15], Female: [0.2,0.35,0.55,0.75] }, 
        cues: ["Handles mid-chest.", "Elbows ~45¬∞.", "Shoulder blades back."], 
        progression: "Add weight when you can do 12+ controlled reps." 
      },
      "pec_fly": { 
        type: 'machine',
        name: "Pec Fly", 
        target: "Chest", 
        muscles: "Chest, Front Delts", 
        tags: ["Push","Upper"], 
        stackCap: 200, 
        multipliers: { Male: [0.2,0.35,0.55,0.8], Female: [0.12,0.25,0.4,0.6] }, 
        cues: ["Soft bend in elbows.", "Move from shoulders."], 
        progression: "Increase when 12+ reps feel easy with full ROM." 
      },
      "shoulder_press": { 
        type: 'machine',
        name: "Shoulder Press", 
        target: "Shoulders", 
        muscles: "Delts, Triceps", 
        tags: ["Push","Upper","Full Body"], 
        stackCap: 200, 
        multipliers: { Male: [0.2,0.4,0.65,0.95], Female: [0.12,0.25,0.4,0.6] }, 
        cues: ["Start at ear level.", "Press straight up.", "Brace core."], 
        progression: "Increase when 10‚Äì12 reps feel solid." 
      },
      "cable_tricep": { 
        type: 'machine',
        name: "Cable Tricep Push", 
        target: "Triceps", 
        muscles: "Triceps", 
        tags: ["Push","Upper"], 
        stackCap: 70, 
        ratio: 0.5, 
        multipliers: { Male: [0.25,0.4,0.6,0.85], Female: [0.18,0.3,0.45,0.65] }, 
        cues: ["Elbows pinned.", "Full extension."], 
        progression: "Increase when 12+ reps feel clean." 
      },
      "lat_pulldown": { 
        type: 'machine',
        name: "Lat Pulldown", 
        target: "Back", 
        muscles: "Lats, Biceps", 
        tags: ["Pull","Upper","Full Body"], 
        stackCap: 250, 
        multipliers: { Male: [0.35,0.6,0.9,1.2], Female: [0.25,0.4,0.65,0.9] }, 
        cues: ["Pull to clavicle.", "No swinging.", "Back does the work."], 
        progression: "Add weight when 12+ reps are controlled." 
      },
      "seated_row": { 
        type: 'machine',
        name: "Seated Row", 
        target: "Back", 
        muscles: "Back, Biceps", 
        tags: ["Pull","Upper"], 
        stackCap: 250, 
        multipliers: { Male: [0.4,0.65,1.0,1.35], Female: [0.28,0.45,0.7,0.95] }, 
        cues: ["Chest to pad.", "Pull to lower ribs."], 
        progression: "Progress when all sets are clean." 
      },
      "cable_bicep": { 
        type: 'machine',
        name: "Cable Bicep Curl", 
        target: "Biceps", 
        muscles: "Biceps, Forearms", 
        tags: ["Pull","Upper"], 
        stackCap: 60, 
        ratio: 0.5, 
        multipliers: { Male: [0.15,0.25,0.4,0.55], Female: [0.1,0.2,0.3,0.4] }, 
        cues: ["Elbows fixed.", "Slow negative."], 
        progression: "Increase when 12+ strict reps are easy." 
      },
      "leg_press": { 
        type: 'machine',
        name: "Leg Press", 
        target: "Legs", 
        muscles: "Quads, Glutes, Hamstrings", 
        tags: ["Push","Legs","Full Body"], 
        stackCap: 700, 
        multipliers: { Male: [1.0,1.6,2.3,3.0], Female: [0.7,1.1,1.6,2.2] }, 
        cues: ["No knee lockout.", "Controlled depth."], 
        progression: "Add weight when 15+ reps are strong and safe." 
      },
      "leg_extension": { 
        type: 'machine',
        name: "Leg Extension", 
        target: "Quads", 
        muscles: "Quadriceps", 
        tags: ["Push","Legs"], 
        stackCap: 200, 
        multipliers: { Male: [0.35,0.6,0.9,1.2], Female: [0.25,0.45,0.7,0.95] }, 
        cues: ["Align knee with pivot.", "Control descent."], 
        progression: "Increase when 12‚Äì15 reps are easy." 
      },
      "leg_curl": { 
        type: 'machine',
        name: "Leg Curl", 
        target: "Hamstrings", 
        muscles: "Hamstrings", 
        tags: ["Pull","Legs"], 
        stackCap: 200, 
        multipliers: { Male: [0.35,0.55,0.8,1.05], Female: [0.25,0.4,0.6,0.8] }, 
        cues: ["Hips down.", "Smooth reps."], 
        progression: "Increase when reps are controlled." 
      },
      "ab_crunch": { 
        type: 'machine',
        name: "Ab Crunch", 
        target: "Core", 
        muscles: "Abs", 
        tags: ["Core","Full Body"], 
        stackCap: 200, 
        multipliers: { Male: [0.3,0.5,0.75,1.0], Female: [0.2,0.35,0.55,0.75] }, 
        cues: ["Ribs to pelvis.", "Exhale."], 
        progression: "Increase when 20+ reps are clean." 
      },

      // ========== DUMBBELLS ==========
      "db_bench_press": {
        type: 'dumbbell',
        name: "Dumbbell Bench Press",
        target: "Chest",
        muscles: "Chest, Triceps, Front Delts",
        tags: ["Push","Upper"],
        multipliers: { Male: [0.15, 0.25, 0.4, 0.55], Female: [0.1, 0.18, 0.28, 0.38] },
        cues: ["Dumbbells at chest level.", "Press up and slightly in.", "Control the descent."],
        progression: "Increase weight when you can do 12 reps with good form."
      },
      "db_row": {
        type: 'dumbbell',
        name: "Dumbbell Row",
        target: "Back",
        muscles: "Back, Biceps",
        tags: ["Pull","Upper"],
        multipliers: { Male: [0.2, 0.35, 0.5, 0.7], Female: [0.12, 0.22, 0.35, 0.48] },
        cues: ["Row to hip.", "Elbow stays close.", "Squeeze at top."],
        progression: "Add weight when 10-12 reps feel controlled."
      },
      "db_shoulder_press": {
        type: 'dumbbell',
        name: "Dumbbell Shoulder Press",
        target: "Shoulders",
        muscles: "Delts, Triceps",
        tags: ["Push","Upper"],
        multipliers: { Male: [0.12, 0.22, 0.35, 0.5], Female: [0.08, 0.15, 0.25, 0.35] },
        cues: ["Start at shoulders.", "Press straight up.", "Control the descent."],
        progression: "Increase when 10-12 reps are solid."
      },
      "db_goblet_squat": {
        type: 'dumbbell',
        name: "Goblet Squat",
        target: "Legs",
        muscles: "Quads, Glutes",
        tags: ["Push","Legs"],
        multipliers: { Male: [0.25, 0.4, 0.6, 0.8], Female: [0.18, 0.3, 0.45, 0.6] },
        cues: ["Hold at chest.", "Squat deep.", "Drive through heels."],
        progression: "Add weight when 15+ reps feel strong."
      },
      "db_lunge": {
        type: 'dumbbell',
        name: "Dumbbell Lunges",
        target: "Legs",
        muscles: "Quads, Glutes, Hamstrings",
        tags: ["Push","Legs"],
        multipliers: { Male: [0.15, 0.25, 0.4, 0.55], Female: [0.1, 0.18, 0.28, 0.4] },
        cues: ["Step forward.", "Knee at 90¬∞.", "Push back to start."],
        progression: "Increase when all reps are controlled."
      },
      "db_curl": {
        type: 'dumbbell',
        name: "Dumbbell Curl",
        target: "Biceps",
        muscles: "Biceps, Forearms",
        tags: ["Pull","Upper"],
        multipliers: { Male: [0.1, 0.18, 0.28, 0.4], Female: [0.06, 0.12, 0.2, 0.28] },
        cues: ["Elbows fixed.", "Curl to shoulder.", "Slow negative."],
        progression: "Add weight when 12+ strict reps are easy."
      },

      // ========== BARBELLS ==========
      "bb_squat": {
        type: 'barbell',
        name: "Barbell Squat",
        target: "Legs",
        muscles: "Quads, Glutes, Hamstrings",
        tags: ["Push","Legs"],
        needsBarWeight: true,
        plateOptions: [45, 35, 25, 10, 5, 2.5],
        multipliers: { Male: [0.8, 1.2, 1.7, 2.2], Female: [0.5, 0.9, 1.3, 1.7] },
        cues: ["Bar on traps.", "Depth to parallel.", "Drive through heels."],
        progression: "Add weight when you hit 8+ reps with good depth."
      },
      "bb_bench": {
        type: 'barbell',
        name: "Barbell Bench Press",
        target: "Chest",
        muscles: "Chest, Triceps, Front Delts",
        tags: ["Push","Upper"],
        needsBarWeight: true,
        plateOptions: [45, 35, 25, 10, 5, 2.5],
        multipliers: { Male: [0.5, 0.8, 1.1, 1.4], Female: [0.25, 0.45, 0.65, 0.85] },
        cues: ["Bar to mid-chest.", "Elbows 45¬∞.", "Feet planted."],
        progression: "Increase when you can do 8-10 solid reps."
      },
      "bb_deadlift": {
        type: 'barbell',
        name: "Barbell Deadlift",
        target: "Back",
        muscles: "Back, Glutes, Hamstrings",
        tags: ["Pull","Legs"],
        needsBarWeight: true,
        plateOptions: [45, 35, 25, 10, 5, 2.5],
        multipliers: { Male: [1.0, 1.5, 2.0, 2.5], Female: [0.6, 1.0, 1.4, 1.8] },
        cues: ["Bar over mid-foot.", "Chest up.", "Drive through floor."],
        progression: "Add weight when 6-8 reps are strong."
      },
      "bb_row": {
        type: 'barbell',
        name: "Barbell Row",
        target: "Back",
        muscles: "Back, Biceps",
        tags: ["Pull","Upper"],
        needsBarWeight: true,
        plateOptions: [45, 35, 25, 10, 5, 2.5],
        multipliers: { Male: [0.4, 0.65, 0.9, 1.2], Female: [0.25, 0.45, 0.65, 0.85] },
        cues: ["Hinge at hips.", "Row to belly.", "No swinging."],
        progression: "Increase when 10+ reps are controlled."
      },
      "bb_overhead_press": {
        type: 'barbell',
        name: "Overhead Press",
        target: "Shoulders",
        muscles: "Delts, Triceps",
        tags: ["Push","Upper"],
        needsBarWeight: true,
        plateOptions: [45, 35, 25, 10, 5, 2.5],
        multipliers: { Male: [0.3, 0.5, 0.7, 0.95], Female: [0.18, 0.3, 0.45, 0.6] },
        cues: ["Bar at clavicle.", "Press straight up.", "Lockout overhead."],
        progression: "Add weight when 8-10 reps are solid."
      },
    };

    const WORKOUT_PLANS = {
      Push: {
        machines: ["chest_press","shoulder_press","pec_fly","cable_tricep"],
        dumbbells: ["db_bench_press","db_shoulder_press"],
        barbells: ["bb_bench","bb_overhead_press"]
      },
      Pull: {
        machines: ["lat_pulldown","seated_row","cable_bicep","ab_crunch"],
        dumbbells: ["db_row","db_curl"],
        barbells: ["bb_deadlift","bb_row"]
      },
      Legs: {
        machines: ["leg_press","leg_extension","leg_curl","ab_crunch"],
        dumbbells: ["db_goblet_squat","db_lunge"],
        barbells: ["bb_squat"]
      }
    };

    const BIG_BASICS = [
      "chest_press", "lat_pulldown", "seated_row", "shoulder_press", "leg_press", "leg_curl",
      "db_bench_press", "db_row", "db_shoulder_press", "db_curl",
      "bb_squat", "bb_bench", "bb_deadlift", "bb_row", "bb_overhead_press"
    ];

    // ========== UTILITIES ==========
    const clampTo5 = (n) => Math.max(10, Math.round(n / 5) * 5);

    const toDayKey = (date = new Date()) => {
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,'0');
      const d = String(date.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    };

    const uniqueDayKeysFromHistory = (history) => {
      const keys = new Set();
      Object.values(history || {}).forEach(arr => {
        (arr || []).forEach(s => {
          if (s?.date) keys.add(toDayKey(new Date(s.date)));
        });
      });
      return Array.from(keys).sort();
    };

    const computeStreak = (history) => {
      const days = uniqueDayKeysFromHistory(history);
      if (days.length === 0) return { current: 0, best: 0, lastDayKey: null, hasToday: false };

      let best = 1, run = 1;
      for (let i=1;i<days.length;i++){
        const prev = new Date(days[i-1]);
        const cur = new Date(days[i]);
        const diff = (cur - prev) / 86400000;
        if (diff === 1) { run++; best = Math.max(best, run); }
        else run = 1;
      }

      const todayKey = toDayKey(new Date());
      let current = 1;
      let i = days.length - 1;
      let anchor = days[i];

      while (i > 0) {
        const a = new Date(days[i-1]);
        const b = new Date(days[i]);
        const diff = (b - a) / 86400000;
        if (diff === 1) current++;
        else break;
        i--;
      }

      return { current, best, lastDayKey: anchor, hasToday: anchor === todayKey };
    };

    const calculatePlateLoading = (targetWeight, barWeight = 45) => {
      const plateOptions = [45, 35, 25, 10, 5, 2.5];
      const perSide = (targetWeight - barWeight) / 2;
      
      if (perSide <= 0) return { plates: [], perSide: 0, total: barWeight, display: 'Empty bar' };
      
      const plates = [];
      let remaining = perSide;
      
      for (const plate of plateOptions) {
        while (remaining >= plate) {
          plates.push(plate);
          remaining -= plate;
        }
      }
      
      const totalPerSide = plates.reduce((sum, p) => sum + p, 0);
      const total = barWeight + (totalPerSide * 2);
      
      return {
        plates,
        perSide: totalPerSide,
        total,
        display: plates.length > 0 ? plates.join(' + ') + ' per side' : 'Empty bar'
      };
    };

    const getProgressionAdvice = (sessions, currentBest) => {
      if (!sessions || sessions.length < 2) return null;
      const recentSessions = sessions.slice(-3);
      let easyCount = 0, goodCount = 0, hardCount = 0, atBest = 0;

      recentSessions.forEach(session => {
        (session.sets || []).forEach(set => {
          if (set.weight === currentBest) {
            atBest++;
            if (set.difficulty === 'easy') easyCount++;
            if (set.difficulty === 'good') goodCount++;
            if (set.difficulty === 'hard') hardCount++;
          }
        });
      });

      if (atBest >= 3 && (easyCount >= 2 || (easyCount + goodCount >= 3))) return { type: 'ready', message: 'Ready to bump weight next time' };
      if (atBest >= 2 && (goodCount + hardCount >= 2)) return { type: 'building', message: 'Keep building - you are close' };
      return null;
    };
    
    // ========== CALCULATIONS ==========
    const getBestForEquipment = (sessions = []) => {
      let best = 0;
      sessions.forEach(s => {
        (s.sets || []).forEach(set => { if (set.weight > best) best = set.weight; });
      });
      return best || null;
    };

    const getStrongWeightForEquipment = (profile, equipId) => {
      const eq = EQUIPMENT_DB[equipId];
      const advancedIdx = 3;
      let w = (profile.weight || 0) * (eq.multipliers?.[profile.gender]?.[advancedIdx] || 0) * (eq.ratio || 1);
      if (eq.type === 'machine' && eq.stackCap) w = Math.min(w, eq.stackCap);
      return clampTo5(w || 10);
    };

    const getNextTarget = (profile, equipId, best) => {
      const eq = EQUIPMENT_DB[equipId];
      if (best) {
        const increment = eq.tags.includes('Legs') ? 10 : 5;
        return clampTo5(best + increment);
      }
      const expIdx = EXPERIENCE_LEVELS.findIndex(e => e.label === profile.experience);
      let w = (profile.weight || 0) * (eq.multipliers?.[profile.gender]?.[expIdx] || 0) * (eq.ratio || 1);
      if (eq.type === 'machine' && eq.stackCap) w = Math.min(w, eq.stackCap);
      return clampTo5(w || 10);
    };

    const computeStrengthScore = (profile, history) => {
      const ids = Object.keys(EQUIPMENT_DB);
      const logged = ids.filter(id => (history[id] || []).length > 0);
      if (logged.length === 0) return { score: 0, avgPct: 0, coveragePct: 0, loggedCount: 0, total: ids.length };
      const ratios = logged.map(id => {
        const best = getBestForEquipment(history[id] || []);
        const strong = getStrongWeightForEquipment(profile, id);
        return best ? Math.min(1, best / strong) : 0;
      });
      const avg = ratios.reduce((a,b)=>a+b,0) / ratios.length;
      const coverage = logged.length / ids.length;
      const score01 = (avg * 0.8) + (coverage * 0.2);
      return { score: Math.round(score01 * 100), avgPct: Math.round(avg*100), coveragePct: Math.round(coverage*100), loggedCount: logged.length, total: ids.length };
    };

    const computeAchievements = ({ history, strengthScoreObj, streakObj }) => {
      const days = uniqueDayKeysFromHistory(history);
      const sessionsTotal = Object.values(history || {}).reduce((sum, arr) => sum + (arr?.length || 0), 0);
      const equipmentLogged = Object.keys(EQUIPMENT_DB).filter(id => (history[id] || []).length > 0).length;
      return [
        { id: 'first', title: 'First Log', desc: 'Logged your first session', unlocked: sessionsTotal >= 1, emoji: '‚úÖ' },
        { id: '3days', title: '3-Day Streak', desc: '3 consecutive training days', unlocked: streakObj.best >= 3, emoji: 'üî•' },
        { id: '7days', title: '7-Day Streak', desc: '7 consecutive training days', unlocked: streakObj.best >= 7, emoji: 'üèÜ' },
        { id: 'score50', title: 'Strength Tier 50', desc: 'Strength Score hit 50', unlocked: strengthScoreObj.score >= 50, emoji: 'üí™' },
        { id: 'score75', title: 'Strength Tier 75', desc: 'Strength Score hit 75', unlocked: strengthScoreObj.score >= 75, emoji: '‚ö°' },
        { id: 'equipment5', title: 'Explorer', desc: 'Logged 5+ exercises', unlocked: equipmentLogged >= 5, emoji: 'üß≠' },
        { id: 'days10', title: 'Show Up Club', desc: 'Trained on 10 different days', unlocked: days.length >= 10, emoji: 'üìÖ' },
      ];
    };

    const getTodaysWorkoutType = (history, appState) => {
      const order = ["Push","Pull","Legs"];
      const lastType = appState?.lastWorkoutType || null;
      const lastDayKey = appState?.lastWorkoutDayKey || null;
      const todayKey = toDayKey(new Date());
      if (lastDayKey === todayKey && lastType) return lastType;
      if (!lastType) return "Push";
      const idx = order.indexOf(lastType);
      return order[(idx + 1) % order.length] || "Push";
    };


    // ========== COMPONENTS ==========
    const Card = ({ children, className = '', onClick }) => (
      <div onClick={onClick} className={`bg-white p-4 rounded-xl border border-gray-200 ${className}`}>{children}</div>
    );

    const TabBar = ({ currentTab, setTab }) => (
      <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50" style={{ paddingBottom: 'env(safe-area-inset-bottom)' }}>
        <div className="flex justify-around items-center h-16 px-2">
          {[{ id: 'home', label: 'Home', icon: 'Home' },{ id: 'workout', label: 'Workout', icon: 'Dumbbell' },{ id: 'progress', label: 'Progress', icon: 'TrendingUp' },{ id: 'profile', label: 'Profile', icon: 'User' }].map(t => (
            <button key={t.id} onClick={() => setTab(t.id)} className={`flex flex-col items-center gap-1 w-full h-full justify-center transition-colors ${currentTab === t.id ? 'text-purple-600' : 'text-gray-400'}`}>
              <Icon name={t.icon} className="w-6 h-6" />
              <span className="text-xs font-semibold">{t.label}</span>
            </button>
          ))}
        </div>
      </div>
    );
    
    // ========== ONBOARDING ==========
    const IntroScreen = ({ onComplete }) => {
      const [card, setCard] = useState(0);
      const cards = [
        { icon: "üí™", title: "Track Your Strength", body: "Simple logging. Real progress. No calorie police." },
        { icon: "Sparkles", title: "Made for Your Gym", body: "Planet Fitness? Commercial gym? Home setup? We've got you." },
        { icon: "Trophy", title: "Watch Progress Stack", body: "Every session builds strength. We'll show you how much." }
      ];
      const current = cards[card];
      const isLast = card === cards.length - 1;
      return (
        <div className="min-h-screen bg-purple-600 flex flex-col p-6">
          <div className="flex-1 flex flex-col items-center justify-center">
            <div className="w-full max-w-sm">
              <div className="bg-white/10 backdrop-blur border border-white/20 rounded-2xl p-8 text-center text-white mb-8 flex flex-col justify-center" style={{minHeight: '240px'}}>
                <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                  {typeof current.icon === 'string' && current.icon.length <= 2 ? current.icon : <Icon name={current.icon} className="w-7 h-7" />}
                </div>
                <h1 className="text-xl font-bold mb-2">{current.title}</h1>
                <p className="text-white/80 leading-relaxed text-sm">{current.body}</p>
              </div>
              <div className="flex justify-center gap-2 mb-6">
                {cards.map((_, i) => (
                  <button key={i} onClick={() => setCard(i)} className={`h-1.5 rounded-full transition-all ${i === card ? 'w-6 bg-white' : 'w-1.5 bg-white/30'}`} />
                ))}
              </div>
              <button onClick={() => isLast ? onComplete() : setCard(c => c + 1)} className="w-full bg-white text-purple-600 font-semibold py-3 rounded-xl">
                {isLast ? "Let's Go" : "Next"}
              </button>
            </div>
          </div>
        </div>
      );
    };

    const ProfileSetup = ({ profile, setProfile, onComplete }) => {
      const [step, setStep] = useState(0);
      const steps = [
        {
          title: "What's your name?",
          canProgress: profile.username.length > 0,
          content: (
            <div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
              <div className="flex items-center gap-5">
                <div className="relative flex-shrink-0">
                  <div className="w-20 h-20 bg-purple-50 rounded-2xl flex items-center justify-center text-4xl">{profile.avatar}</div>
                  <select className="absolute inset-0 opacity-0 cursor-pointer" value={profile.avatar} onChange={e => setProfile({...profile, avatar: e.target.value})}>
                    {AVATARS.map(a => <option key={a} value={a}>{a}</option>)}
                  </select>
                </div>
                <div className="flex-1">
                  <label className="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2 block">Your Name</label>
                  <input type="text" value={profile.username} onChange={e => setProfile({...profile, username: e.target.value})} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-semibold" placeholder="Enter your name" autoFocus />
                </div>
              </div>
            </div>
          )
        },
        {
          title: "Where do you train?",
          canProgress: profile.gymType && profile.gymType.length > 0,
          content: (
            <div className="space-y-3">
              {Object.entries(GYM_TYPES).map(([key, gym]) => (
                <button key={key} onClick={() => setProfile({...profile, gymType: key})} className={`w-full p-4 rounded-xl border-2 text-left flex items-center gap-3 ${profile.gymType === key ? 'border-purple-400 bg-purple-50' : 'border-gray-200 bg-white'}`}>
                  <div className="text-3xl">{gym.emoji}</div>
                  <div className="flex-1"><div className="font-bold">{gym.label}</div><div className="text-xs text-gray-500">{gym.desc}</div></div>
                </button>
              ))}
            </div>
          )
        }
      ];
      const currentStep = steps[step];
      const isLast = step === steps.length - 1;
      return (
        <div className="min-h-screen bg-gray-50 flex flex-col">
          <div className="flex-1 overflow-y-auto p-6 pt-12">
            <h1 className="text-2xl font-black mb-6">{currentStep.title}</h1>
            {currentStep.content}
          </div>
          <div className="p-4 bg-white border-t border-gray-100">
             <button onClick={() => isLast ? onComplete() : setStep(s => s + 1)} disabled={!currentStep.canProgress} className={`w-full py-4 rounded-2xl font-bold text-white ${currentStep.canProgress ? 'bg-purple-600' : 'bg-gray-300'}`}>{isLast ? 'Start Logging üöÄ' : 'Next'}</button>
          </div>
        </div>
      );
    };


    // ========== HOME SCREEN ==========
    const Home = ({ profile, setProfile, history, appState, setAppState, onGoWorkout, onStartSuggestedWorkout, onGoProfile, streakObj, achievements, todayWorkoutType }) => {
      const [showAchievements, setShowAchievements] = useState(false);
      const todayKey = toDayKey(new Date());
      const doneToday = useMemo(() => uniqueDayKeysFromHistory(history).includes(todayKey), [history]);
      
      const gymType = GYM_TYPES[profile.gymType];
      const availableTypes = [];
      if (gymType?.machines) availableTypes.push('machines');
      if (gymType?.dumbbells?.available) availableTypes.push('dumbbells');
      if (gymType?.barbells?.available) availableTypes.push('barbells');

      const suggestedExercises = useMemo(() => {
        const plan = WORKOUT_PLANS[todayWorkoutType];
        const suggested = [];
        availableTypes.forEach(type => { suggested.push(...(plan[type] || [])); });
        return suggested.slice(0, 4);
      }, [todayWorkoutType, gymType]);

      return (
        <div className="flex flex-col h-full bg-gray-50">
          <div className="bg-white border-b border-gray-100 sticky top-0 z-20" style={{ paddingTop: 'env(safe-area-inset-top)' }}>
            <div className="p-4 py-5 flex items-center justify-between">
              <div><div className="text-xs text-gray-400 font-bold uppercase">Planet Strength</div><h1 className="text-2xl font-black">Hey, {profile.username}</h1></div>
              <button onClick={onGoProfile} className="w-12 h-12 rounded-2xl bg-purple-50 flex items-center justify-center text-2xl">{profile.avatar}</button>
            </div>
          </div>
          <div className="flex-1 overflow-y-auto p-4 pb-24 space-y-4">
            <Card className="bg-gradient-to-br from-purple-50 to-indigo-50 border-purple-200">
              <div className="text-sm font-medium italic text-purple-900">"{motivationalQuotes[0].quote}"</div>
            </Card>

            <Card>
              <div className="flex items-center justify-between mb-3">
                <div><div className="text-xs text-gray-400 font-bold uppercase">Today's Workout</div><div className="text-lg font-black">{todayWorkoutType} Day</div></div>
                <button onClick={() => {
                   const order = ["Push","Pull","Legs"];
                   const idx = order.indexOf(todayWorkoutType);
                   setAppState(prev => ({ ...prev, lastWorkoutType: order[(idx + 1) % order.length], lastWorkoutDayKey: toDayKey(new Date()) }));
                }} className="px-4 py-2 bg-gray-50 text-gray-700 rounded-xl text-sm font-bold border border-gray-200">Swap</button>
              </div>
              <div className="grid grid-cols-2 gap-2 mb-3">
                {suggestedExercises.map(id => {
                  const eq = EQUIPMENT_DB[id];
                  return <div key={id} className="p-3 bg-gray-50 rounded-xl border border-gray-100 text-center"><div className="text-2xl mb-1">{eq.type === 'machine' ? '‚öôÔ∏è' : eq.type === 'dumbbell' ? 'üèãÔ∏è' : 'üèãÔ∏è‚Äç‚ôÇÔ∏è'}</div><div className="font-bold text-xs">{eq.name}</div></div>
                })}
              </div>
              <button onClick={onStartSuggestedWorkout} className="w-full bg-purple-600 text-white font-semibold py-3 rounded-xl mb-2">{doneToday ? "Start Another Set" : "Start Workout"}</button>
              <button onClick={onGoWorkout} className="w-full py-2 bg-gray-100 text-gray-700 rounded-xl font-medium text-sm">Browse All</button>
            </Card>

            <Card>
              <button onClick={() => setShowAchievements(!showAchievements)} className="w-full flex items-center justify-between">
                <div className="text-left"><div className="text-xs text-gray-400 font-bold uppercase">Achievements</div><div className="text-sm text-gray-600">{achievements.filter(a=>a.unlocked).length}/{achievements.length} unlocked</div></div>
                <Icon name="ChevronDown" className={`w-5 h-5 text-gray-400 ${showAchievements ? 'rotate-180' : ''}`} />
              </button>
              {showAchievements && (
                <div className="grid grid-cols-2 gap-2 mt-3 animate-expand">
                  {achievements.map(a => (
                    <div key={a.id} className={`p-3 rounded-xl border text-left ${a.unlocked ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
                      <div className="text-lg">{a.emoji}</div><div className={`text-sm font-black ${a.unlocked ? 'text-green-800' : 'text-gray-700'}`}>{a.title}</div>
                    </div>
                  ))}
                </div>
              )}
            </Card>
          </div>
        </div>
      );
    };

    // ========== SUGGESTED WORKOUT SCREEN ==========
    const SuggestedWorkout = ({ profile, history, suggestedExercises, todayWorkoutType, onEquipmentSelect, onBack }) => {
      return (
        <div className="flex flex-col h-full bg-gray-50">
          <div className="bg-white border-b border-gray-100 sticky top-0 z-20" style={{ paddingTop: 'env(safe-area-inset-top)' }}>
            <div className="p-4 py-5 flex items-center gap-4">
              <button onClick={onBack} className="text-gray-600"><Icon name="ChevronLeft" className="w-6 h-6" /></button>
              <div><div className="text-xs text-gray-400 font-bold uppercase">Today's Workout</div><h1 className="text-2xl font-black">{todayWorkoutType} Day</h1></div>
            </div>
          </div>
          <div className="flex-1 overflow-y-auto p-4 pb-24">
            <div className="grid grid-cols-2 gap-3">
              {suggestedExercises.map((id, index) => {
                const eq = EQUIPMENT_DB[id];
                const sessions = history[id] || [];
                const best = getBestForEquipment(sessions);
                return (
                  <button key={id} onClick={() => onEquipmentSelect(id)} className="bg-white p-3 rounded-xl border-2 border-gray-100 active:scale-[0.98] transition-all text-center hover:border-purple-200 shadow-sm">
                    <div className="text-xs font-bold text-purple-600 bg-purple-50 px-2 py-1 rounded inline-block mb-2">#{index + 1}</div>
                    <div className="text-3xl mb-2">{eq.type === 'machine' ? '‚öôÔ∏è' : eq.type === 'dumbbell' ? 'üèãÔ∏è' : 'üèãÔ∏è‚Äç‚ôÇÔ∏è'}</div>
                    <h3 className="font-bold text-sm mb-1">{eq.name}</h3>
                    <div className="text-xs text-gray-500">{eq.target}</div>
                    {best > 0 && <div className="mt-2 text-xs font-bold text-gray-900">Best: {best} lbs</div>}
                  </button>
                );
              })}
            </div>
          </div>
        </div>
      );
    };

    // ========== WORKOUT LIST ==========
    const Workout = ({ profile, setProfile, history, onEquipmentSelect, settings, todayWorkoutType }) => {
      const [filter, setFilter] = useState('All');
      const gymType = GYM_TYPES[profile.gymType];
      
      const availableEquipment = useMemo(() => {
        const ids = Object.keys(EQUIPMENT_DB);
        return ids.filter(id => {
          const eq = EQUIPMENT_DB[id];
          if (eq.type === 'machine') return gymType?.machines;
          if (eq.type === 'dumbbell') return gymType?.dumbbells?.available;
          if (eq.type === 'barbell') return gymType?.barbells?.available;
          return false;
        });
      }, [gymType]);

      const filteredEquipment = useMemo(() => {
        let result = availableEquipment;
        if (filter === 'Today') {
           const plan = WORKOUT_PLANS[todayWorkoutType];
           // simplistic filter for demo
           result = availableEquipment.filter(id => plan.machines?.includes(id) || plan.dumbbells?.includes(id) || plan.barbells?.includes(id));
        } else if (filter !== 'All') {
           if (['Push','Pull','Legs'].includes(filter)) result = availableEquipment.filter(id => EQUIPMENT_DB[id].tags.includes(filter));
           else result = availableEquipment.filter(id => EQUIPMENT_DB[id].type === filter.toLowerCase().slice(0, -1)); // simple hack for plural
        }
        if (!settings.showAllExercises && filter === 'All') return result.filter(id => BIG_BASICS.includes(id));
        return result;
      }, [filter, availableEquipment, todayWorkoutType, settings]);

      return (
        <div className="flex flex-col h-full bg-gray-50">
          <div className="bg-white border-b border-gray-100 sticky top-0 z-20" style={{ paddingTop: 'env(safe-area-inset-top)' }}>
            <div className="p-4 pb-0">
               <h1 className="text-2xl font-black mb-4">Workout</h1>
               <div className="flex gap-2 overflow-x-auto no-scrollbar pb-3">
                 {['All', 'Today', 'Push', 'Pull', 'Legs'].map(f => (
                   <button key={f} onClick={() => setFilter(f)} className={`whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-bold transition-all ${filter === f ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-500'}`}>{f}</button>
                 ))}
               </div>
            </div>
          </div>
          <div className="flex-1 overflow-y-auto p-4 pb-24 grid grid-cols-3 gap-2 align-start">
             {filteredEquipment.map(id => {
                const eq = EQUIPMENT_DB[id];
                const sessions = history[id] || [];
                const best = getBestForEquipment(sessions);
                const next = getNextTarget(profile, id, best);
                return (
                  <div key={id} onClick={() => onEquipmentSelect(id)} className="bg-white p-2 rounded-xl border border-gray-100 active:scale-[0.98] transition-transform text-center shadow-sm h-min">
                    <div className="text-xl mb-1">{eq.type === 'machine' ? '‚öôÔ∏è' : eq.type === 'dumbbell' ? 'üèãÔ∏è' : 'üèãÔ∏è‚Äç‚ôÇÔ∏è'}</div>
                    <div className="text-[10px] font-bold leading-tight mb-1">{eq.name}</div>
                    <div className="text-[9px] text-gray-400 mb-1">{eq.target}</div>
                    <div className="pt-1 border-t border-gray-50">
                       {best ? <div className="text-xs font-black">{best}<span className="text-[8px] text-gray-400">lbs</span></div> : <div className="text-xs font-black text-purple-600">{next}<span className="text-[8px]">lbs</span></div>}
                    </div>
                  </div>
                )
             })}
          </div>
        </div>
      );
    };

    // ========== EQUIPMENT DETAIL ==========
    const PlateCalculator = ({ targetWeight, barWeight, onClose }) => {
      const plates = [45, 35, 25, 10, 5, 2.5];
      const calculate = (w) => {
         const perSide = (w - barWeight)/2;
         if(perSide <= 0) return [];
         const res = [];
         let r = perSide;
         plates.forEach(p => { while(r >= p){ res.push(p); r -= p; }});
         return res;
      };
      const loaded = calculate(targetWeight);
      return (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100]" onClick={onClose}>
          <div className="bg-white rounded-2xl p-6 w-full max-w-sm m-4" onClick={e=>e.stopPropagation()}>
             <h3 className="font-bold text-lg mb-4">Load Each Side</h3>
             <div className="flex flex-wrap gap-2 justify-center mb-4">
                {loaded.length ? loaded.map((p,i)=><div key={i} className="bg-purple-600 text-white font-bold py-2 px-4 rounded">{p}</div>) : "Just the bar"}
             </div>
             <button onClick={onClose} className="w-full py-3 bg-gray-100 font-bold rounded-xl">Close</button>
          </div>
        </div>
      )
    };

    const EquipmentDetail = ({ id, profile, history, onSave, onClose }) => {
      const eq = EQUIPMENT_DB[id];
      const best = getBestForEquipment(history);
      const [sets, setSets] = useState([{ weight: '', reps: '' }, { weight: '', reps: '' }, { weight: '', reps: '' }]);
      const [showPlateCalc, setShowPlateCalc] = useState(false);

      const handleSave = () => {
         const valid = sets.filter(s => s.weight && s.reps).map(s => ({ weight: Number(s.weight), reps: Number(s.reps) }));
         if(valid.length) onSave(id, { date: new Date().toISOString(), sets: valid });
      };

      return (
        <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/40 backdrop-blur-sm">
          <div className="bg-white w-full max-w-md rounded-t-3xl shadow-2xl flex flex-col animate-slide-up" style={{maxHeight: '90vh'}}>
             <div className="p-4 border-b border-gray-100 flex justify-between items-center">
               <div><h2 className="text-lg font-bold">{eq.name}</h2><p className="text-xs text-gray-500">{eq.muscles}</p></div>
               <button onClick={onClose} className="p-2 bg-gray-100 rounded-full"><Icon name="X" className="w-5 h-5"/></button>
             </div>
             <div className="flex-1 overflow-y-auto p-4 space-y-4">
               <div className="bg-purple-50 p-4 rounded-xl border border-purple-100 flex justify-between items-center">
                  <div><div className="text-xs font-bold text-purple-600 uppercase">Your Best</div><div className="text-2xl font-black">{best || '‚Äî'} <span className="text-sm font-normal text-gray-500">lbs</span></div></div>
                  {eq.type === 'barbell' && <button onClick={()=>setShowPlateCalc(true)} className="px-3 py-2 bg-white text-purple-700 font-bold text-xs rounded-lg border border-purple-200">Plate Calc</button>}
               </div>
               
               <div className="space-y-2">
                 {sets.map((s,i) => (
                   <div key={i} className="flex gap-2 items-center">
                     <div className="w-8 text-xs font-bold text-gray-400">#{i+1}</div>
                     <input type="number" placeholder="lbs" className="flex-1 p-3 bg-gray-50 rounded-xl font-bold text-center border border-gray-100" value={s.weight} onChange={e=>{const n=[...sets];n[i].weight=e.target.value;setSets(n)}} />
                     <input type="number" placeholder="reps" className="flex-1 p-3 bg-gray-50 rounded-xl font-bold text-center border border-gray-100" value={s.reps} onChange={e=>{const n=[...sets];n[i].reps=e.target.value;setSets(n)}} />
                   </div>
                 ))}
                 <button onClick={()=>setSets([...sets,{weight:'',reps:''}])} className="text-xs font-bold text-purple-600 w-full py-2">+ Add Set</button>
               </div>

               <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                 <div className="text-xs font-bold text-blue-700 uppercase mb-1">Cues</div>
                 <ul className="list-disc pl-4 text-sm text-blue-900">{eq.cues.map(c=><li key={c}>{c}</li>)}</ul>
               </div>
             </div>
             <div className="p-4 border-t border-gray-100">
               <button onClick={handleSave} className="w-full py-3 bg-purple-600 text-white font-bold rounded-xl">Save Workout</button>
             </div>
          </div>
          {showPlateCalc && <PlateCalculator targetWeight={Number(sets[0].weight||45)} barWeight={profile.barWeight||45} onClose={()=>setShowPlateCalc(false)} />}
        </div>
      );
    };

    // ========== PROGRESS TAB ==========
    const Progress = ({ profile, history, strengthScoreObj }) => {
      return (
        <div className="flex flex-col h-full bg-gray-50">
          <div className="bg-white border-b border-gray-100 sticky top-0 z-10 p-4" style={{ paddingTop: 'env(safe-area-inset-top)' }}>
            <h1 className="text-2xl font-black">Analytics</h1>
          </div>
          <div className="flex-1 overflow-y-auto p-4 pb-24 space-y-4">
             <div className="grid grid-cols-2 gap-2">
               <Card className="text-center">
                 <div className="text-xs text-gray-400 font-bold uppercase">Score</div>
                 <div className="text-4xl font-black text-purple-600">{strengthScoreObj.score}</div>
               </Card>
               <Card className="text-center">
                 <div className="text-xs text-gray-400 font-bold uppercase">Workouts</div>
                 <div className="text-4xl font-black text-gray-900">{Object.values(history).reduce((a,b)=>a+b.length,0)}</div>
               </Card>
             </div>
             
             <Card>
               <h3 className="font-bold mb-3">Recent Logs</h3>
               <div className="space-y-2">
                 {Object.entries(history).flatMap(([k,v]) => v.map(s=>({...s,id:k}))).sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5).map((s,i) => {
                    const eq = EQUIPMENT_DB[s.id];
                    return (
                      <div key={i} className="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                        <div><div className="font-bold text-sm">{eq.name}</div><div className="text-xs text-gray-500">{new Date(s.date).toLocaleDateString()}</div></div>
                        <div className="font-bold text-purple-600">{Math.max(...s.sets.map(x=>x.weight))} lbs</div>
                      </div>
                    )
                 })}
               </div>
             </Card>
          </div>
        </div>
      )
    };

    // ========== PROFILE TAB ==========
    const ProfileView = ({ profile, setProfile, settings, setSettings, onReset }) => {
      const [showUpdateProfile, setShowUpdateProfile] = useState(false);
      const [showAvatarPicker, setShowAvatarPicker] = useState(false);
      
      const gymType = GYM_TYPES[profile.gymType];

      return (
        <div className="flex flex-col h-full bg-gray-50">
          <div className="bg-white border-b border-gray-100 sticky top-0 z-10" style={{ paddingTop: 'env(safe-area-inset-top)' }}>
            <h1 className="text-2xl font-black text-gray-900 p-4 py-5">Profile</h1>
          </div>
          <div className="flex-1 overflow-y-auto p-4 pb-24">
             {/* Header Card */}
            <Card className="mb-6 text-center">
              <button onClick={() => setShowAvatarPicker(!showAvatarPicker)} className="text-6xl mb-2 mx-auto active:scale-95 transition-transform">{profile.avatar}</button>
              {showAvatarPicker && (
                <div className="grid grid-cols-7 gap-2 mb-4 p-3 bg-purple-50 rounded-xl animate-expand">
                  {AVATARS.map(emoji => (
                    <button key={emoji} onClick={() => { setProfile({...profile, avatar: emoji}); setShowAvatarPicker(false); }} className="text-3xl p-2 rounded-lg hover:bg-white">{emoji}</button>
                  ))}
                </div>
              )}
              <h2 className="text-xl font-bold text-gray-900">{profile.username}</h2>
              <p className="text-sm text-gray-500">{gymType?.label} ‚Ä¢ {profile.weight} lbs</p>
            </Card>

            {/* Quick Toggles */}
            <h3 className="text-xs font-bold text-gray-400 uppercase mb-2 px-1">Settings</h3>
            <Card className="mb-4">
              <button onClick={() => setSettings({...settings, darkMode: !settings.darkMode})} className="w-full flex items-center justify-between py-3 border-b border-gray-100">
                <div className="flex items-center gap-3"><Icon name="Moon" className="w-5 h-5 text-indigo-600"/><span className="text-sm font-semibold text-gray-900">Dark Mode</span></div>
                <div className={`w-10 h-6 rounded-full transition-colors relative ${settings.darkMode ? 'bg-indigo-600' : 'bg-gray-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow absolute top-1 transition-all ${settings.darkMode ? 'left-5' : 'left-1'}`}></div></div>
              </button>
              <button onClick={() => setSettings({...settings, showSuggestions: !settings.showSuggestions})} className="w-full flex items-center justify-between py-3">
                <div className="flex items-center gap-3"><Icon name="Lightbulb" className="w-5 h-5 text-purple-600"/><span className="text-sm font-semibold text-gray-900">Suggestions</span></div>
                <div className={`w-10 h-6 rounded-full transition-colors relative ${settings.showSuggestions ? 'bg-purple-600' : 'bg-gray-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow absolute top-1 transition-all ${settings.showSuggestions ? 'left-5' : 'left-1'}`}></div></div>
              </button>
            </Card>

            {/* Update Profile Section */}
            <Card className="mb-4">
              <button onClick={() => setShowUpdateProfile(!showUpdateProfile)} className="w-full flex items-center justify-between">
                <div className="flex items-center gap-3"><Icon name="User" className="w-5 h-5 text-purple-600"/><span className="text-sm font-semibold text-gray-900">Update Profile</span></div>
                <Icon name="ChevronDown" className={`w-5 h-5 text-gray-400 transition-transform ${showUpdateProfile ? 'rotate-180' : ''}`} />
              </button>
              
              {showUpdateProfile && (
                <div className="mt-4 space-y-4 animate-expand border-t border-gray-100 pt-4">
                  <div>
                    <label className="text-xs font-bold text-gray-400 uppercase block mb-1">Weight</label>
                    <input type="number" className="w-full p-3 border border-gray-200 rounded-xl font-bold" value={profile.weight} onChange={e => setProfile({...profile, weight: Number(e.target.value)})} />
                  </div>
                  <div>
                    <label className="text-xs font-bold text-gray-400 uppercase block mb-1">Experience</label>
                    <div className="grid grid-cols-2 gap-2">
                      {EXPERIENCE_LEVELS.map(l => (
                        <button key={l.label} onClick={() => setProfile({...profile, experience: l.label})} className={`p-2 rounded-xl border-2 text-xs font-bold ${profile.experience === l.label ? 'border-purple-400 bg-purple-50 text-purple-700' : 'border-gray-200'}`}>{l.label}</button>
                      ))}
                    </div>
                  </div>
                  {/* Gym Type Selector */}
                  <div>
                    <label className="text-xs font-bold text-gray-400 uppercase block mb-1">Gym Type</label>
                    <div className="space-y-2">
                    {Object.entries(GYM_TYPES).map(([key, gym]) => (
                      <button key={key} onClick={() => setProfile({...profile, gymType: key})} className={`w-full p-3 rounded-xl border-2 text-left flex items-center gap-3 ${profile.gymType === key ? 'border-purple-400 bg-purple-50' : 'border-gray-200'}`}>
                        <span className="text-xl">{gym.emoji}</span>
                        <div><div className="font-bold text-sm text-gray-900">{gym.label}</div></div>
                      </button>
                    ))}
                    </div>
                  </div>
                  
                  {GYM_TYPES[profile.gymType]?.barbells?.available && (
                    <div>
                      <label className="text-xs font-bold text-gray-400 uppercase block mb-1">Bar Weight</label>
                      <input type="number" className="w-full p-3 border border-gray-200 rounded-xl font-bold" value={profile.barWeight} onChange={e => setProfile({...profile, barWeight: Number(e.target.value)})} />
                    </div>
                  )}
                </div>
              )}
            </Card>

            {/* Danger Zone */}
            <button onClick={onReset} className="w-full p-4 rounded-xl font-bold text-red-600 bg-red-50 border border-red-100 flex items-center justify-center gap-2">
              <Icon name="Trash" className="w-4 h-4"/> Reset Data
            </button>
          </div>
        </div>
      );
    };

    // ========== MAIN APP ==========
    const App = () => {
      const [loaded, setLoaded] = useState(false);
      const [profile, setProfile] = useState({ username: '', weight: 0, age: 0, gender: 'Male', experience: 'Beginner', activityLevel: 'Moderately Active', avatar: 'ü¶Å', goal: 'recomp', gymType: 'commercial', barWeight: 45, onboarded: false });
      const [settings, setSettings] = useState({ showSuggestions: true, darkMode: false, showAllExercises: false });
      const [history, setHistory] = useState({});
      const [tab, setTab] = useState('home');
      const [appState, setAppState] = useState({ lastWorkoutType: null, lastWorkoutDayKey: null });
      const [activeEquipment, setActiveEquipment] = useState(null);
      const [showSuggestedWorkout, setShowSuggestedWorkout] = useState(false);

      useEffect(() => {
        const saved = storage.get('ps_v2_profile', null);
        if (saved) setProfile(saved);
        setSettings(storage.get('ps_v2_settings', settings));
        setHistory(storage.get('ps_v2_history', {}));
        setAppState(storage.get('ps_v2_state', appState));
        setLoaded(true);
      }, []);

      useEffect(() => { if(loaded) storage.set('ps_v2_profile', profile); }, [profile, loaded]);
      useEffect(() => { if(loaded) storage.set('ps_v2_settings', settings); }, [settings, loaded]);
      useEffect(() => { if(loaded) storage.set('ps_v2_history', history); }, [history, loaded]);
      useEffect(() => { if(loaded) storage.set('ps_v2_state', appState); }, [appState, loaded]);
      
      useEffect(() => {
        document.body.classList.toggle('dark-mode', settings.darkMode);
      }, [settings.darkMode]);

      const handleReset = () => {
        if(confirm("Reset all data?")) {
          localStorage.clear();
          window.location.reload();
        }
      };

      const handleSaveSession = (id, session) => {
        setHistory(prev => ({ ...prev, [id]: [...(prev[id] || []), session] }));
        setAppState(prev => ({ ...prev, lastWorkoutType: todayWorkoutType, lastWorkoutDayKey: toDayKey(new Date()) }));
        setActiveEquipment(null);
      };
      
      const todayWorkoutType = useMemo(() => getTodaysWorkoutType(history, appState), [history, appState]);
      const strengthScoreObj = useMemo(() => computeStrengthScore(profile, history), [profile, history]);
      const streakObj = useMemo(() => computeStreak(history), [history]);
      const achievements = useMemo(() => computeAchievements({ history, strengthScoreObj, streakObj }), [history]);

      const suggestedExercises = useMemo(() => {
        const gymType = GYM_TYPES[profile.gymType];
        if (!gymType) return [];
        const plan = WORKOUT_PLANS[todayWorkoutType];
        const suggested = [];
        if (gymType.machines) suggested.push(...(plan.machines || []));
        if (gymType.dumbbells?.available) suggested.push(...(plan.dumbbells || []));
        if (gymType.barbells?.available) suggested.push(...(plan.barbells || []));
        return suggested.slice(0, 4);
      }, [profile.gymType, todayWorkoutType]);


      if (!loaded) return null;

      if (!profile.onboarded) {
         return <IntroScreen onComplete={() => setProfile({...profile, onboarded: true})} />;
      }
      
      if (profile.weight === 0 && profile.onboarded) {
         // Force profile setup if skipped/incomplete
         return <ProfileSetup profile={profile} setProfile={setProfile} onComplete={() => setProfile({...profile, weight: profile.weight || 150})} />
      }

      return (
        <>
          <InstallPrompt />
          <div className="h-screen bg-gray-50 flex flex-col overflow-hidden">
            <div className="flex-1 overflow-hidden">
               {showSuggestedWorkout ? (
                 <SuggestedWorkout profile={profile} history={history} suggestedExercises={suggestedExercises} todayWorkoutType={todayWorkoutType} onEquipmentSelect={setActiveEquipment} onBack={() => setShowSuggestedWorkout(false)} />
               ) : (
                 <>
                  {tab === 'home' && <Home profile={profile} setProfile={setProfile} history={history} appState={appState} setAppState={setAppState} onGoWorkout={()=>setTab('workout')} onStartSuggestedWorkout={()=>setShowSuggestedWorkout(true)} onGoProfile={()=>setTab('profile')} streakObj={streakObj} achievements={achievements} todayWorkoutType={todayWorkoutType} />}
                  {tab === 'workout' && <Workout profile={profile} setProfile={setProfile} history={history} onEquipmentSelect={setActiveEquipment} settings={settings} todayWorkoutType={todayWorkoutType} />}
                  {tab === 'progress' && <Progress profile={profile} history={history} strengthScoreObj={strengthScoreObj} />}
                  {tab === 'profile' && <ProfileView profile={profile} setProfile={setProfile} settings={settings} setSettings={setSettings} onReset={handleReset} />}
                 </>
               )}
            </div>
            {!showSuggestedWorkout && <TabBar currentTab={tab} setTab={setTab} />}
            {activeEquipment && <EquipmentDetail id={activeEquipment} profile={profile} history={history[activeEquipment]||[]} onSave={handleSaveSession} onClose={()=>setActiveEquipment(null)} />}
          </div>
        </>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
